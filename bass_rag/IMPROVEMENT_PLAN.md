# RAG/REFRAG 시스템 코드베이스 개선 계획서

**작성일**: 2024년  
**목적**: 코드 품질 개선, 버그 수정, 성능 최적화, 보안 강화  
**예상 기간**: 4-6주 (단계별 진행)

---

## 📋 개요

### 현재 상태
- RAG 시스템 기본 기능 동작
- REFRAG 스타일 요소 부분 구현
- Critical 버그 존재 (테이블 필터링)
- 코드 중복 및 구조적 문제

### 목표
1. Critical 버그 수정으로 답변 정확도 향상
2. 코드 품질 개선으로 유지보수성 향상
3. 안정성 강화 (동시성, 에러 처리)
4. 보안 강화
5. 성능 최적화

---

## 🎯 Phase 1: Critical 버그 수정 (1주차)

### 1.1 테이블 필터링 버그 수정 ⚠️ CRITICAL

**문제**: GPS 테이블 질문에 BMS 변수(`messageTime`, `seq`)가 포함됨

**작업 내용**:
1. `postprocess_answer` 함수에 테이블별 변수 필터링 로직 추가
   - 파일: `app/refrag_server.py:30-198`, `app/rag_server.py:1070-1156`
   - `table_type` 파라미터 기반으로 해당 테이블에 속하지 않는 변수 제외
   - `domain_dict.table_to_variables` 활용하여 변수-테이블 매핑 확인

2. 테이블 필터링 로직 개선
   - 파일: `app/rag_server.py:1305-1330`
   - `is_exact=True`여도 테이블 불일치 시 제외하도록 수정
   - 테이블 필터링을 `is_exact` 체크보다 우선 적용

3. 프롬프트 강화
   - 파일: `app/refrag_server.py:873-875`, `app/rag_server.py:2195-2197`
   - Few-shot 예시에 "GPS 질문에 BMS 변수 포함 시 잘못된 답변" 추가
   - 테이블별 변수 제외 규칙을 더 명확하게 명시

**예상 시간**: 4-6시간  
**우선순위**: P0 (최우선)  
**검증 방법**: 
- GPS 질문: "GPS 테이블에 존재하는 변수지만, 사용하지 않는 변수는?"
- 기대 결과: BMS 변수(`seq`, `messageTime` 등) 제외
- BMS 질문: "BMS 테이블에 존재하는 변수지만, 사용하지 않는 변수는?"
- 기대 결과: GPS 변수(`lat`, `lon`, `speed` 등) 제외

**의존성**: `domain_dict.table_to_variables` 정확성 확인 필요

---

## 🔧 Phase 2: High Priority 개선 (2-3주차)

### 2.1 전역 변수 동시성 문제 해결

**문제**: `faiss_index`, `passages` 등 전역 변수에 동시 접근 시 race condition 가능

**작업 내용**:
1. 인덱스 접근 동기화
   - 파일: `app/refrag_server.py:200-212`, `app/rag_server.py:38-45`
   - `asyncio.Lock` 또는 `threading.Lock` 도입
   - `query`와 `ingest` 엔드포인트에 lock 적용

2. 인덱스 업데이트 전략 개선
   - 파일: `app/rag_server.py:2256-2269`
   - `ingest` 시 즉시 저장 대신 배치 업데이트 고려
   - 또는 Copy-on-Write 패턴 적용

3. Thread-safe 자료구조 검토
   - 전역 변수 접근 패턴 분석
   - 필요시 `collections.deque` 또는 thread-safe 자료구조로 교체

**예상 시간**: 6-8시간  
**우선순위**: P1 (High)  
**검증 방법**:
- 동시 요청 테스트 (100+ concurrent requests)
- 인덱스 일관성 검증
- 메모리 누수 확인

**리스크**: Lock으로 인한 성능 저하 가능 → 성능 테스트 필요

### 2.2 서버 파일 중복 해결

**문제**: `rag_server.py`와 `refrag_server.py`가 유사 기능 중복 구현

**작업 내용**:
1. 현재 사용 현황 분석
   - 두 서버의 실제 사용 여부 확인
   - 엔드포인트 차이점 분석
   - 프론트엔드 연결 확인

2. 통합 전략 수립
   - 옵션 A: 단일 서버로 통합 (`rag_server.py`에 REFRAG 기능 통합)
   - 옵션 B: 역할 명확 분리 (기본 RAG vs REFRAG)
   - 옵션 C: 공통 로직 추출 후 두 서버 유지

3. 공통 로직 추출
   - `postprocess_answer` → `app/utils/postprocess.py`
   - `expand_query_semantically` → `app/utils/query_expansion.py`
   - 하이브리드 검색 로직 → `app/retrieval/hybrid.py`

4. 리팩터링 실행
   - 선택한 전략에 따라 코드 재구성
   - 테스트 및 검증

**예상 시간**: 2-3일  
**우선순위**: P1 (High)  
**검증 방법**:
- 기존 기능 동작 확인
- API 호환성 확인
- 성능 비교

**의존성**: Phase 1 완료 후 진행 권장

---

## 🛡️ Phase 3: Medium Priority 개선 (4주차)

### 3.1 에러 처리 및 로깅 전략 수립

**작업 내용**:
1. 구조화된 로깅 도입
   - `logging` 모듈 설정
   - 로그 레벨별 분리 (DEBUG, INFO, WARNING, ERROR)
   - 파일 로깅 및 로테이션 설정

2. 예외 처리 개선
   - 파일: `app/refrag_server.py:927`, `app/rag_server.py:2226`
   - 예외 타입별 처리 (ValueError, HTTPException, 등)
   - 민감 정보 필터링
   - 에러 로깅 추가

3. 메트릭 수집 (선택적)
   - Prometheus 메트릭 추가
   - 응답 시간, 에러율, 처리량 추적

**예상 시간**: 1-2일  
**우선순위**: P2 (Medium)  
**검증 방법**:
- 에러 시나리오 테스트
- 로그 파일 확인
- 모니터링 대시보드 확인

### 3.2 보안 이슈 해결

**작업 내용**:
1. 하드코딩된 경로 제거
   - 파일: `app/config.py:11`
   - 환경 변수로 경로 관리
   - `.env.example` 파일 생성

2. 파일 업로드 보안 강화
   - 파일: `app/rag_server.py:2272-2428`
   - 파일 크기 제한 추가
   - 파일 타입 검증 강화
   - 경로 traversal 방지
   - 악성 파일 검사 (선택적)

3. 환경 변수 검증
   - 필수 환경 변수 체크
   - URL 형식 검증
   - 포트 범위 검증

**예상 시간**: 1일  
**우선순위**: P2 (Medium)  
**검증 방법**:
- 보안 스캔 도구 사용
- 파일 업로드 공격 시나리오 테스트

### 3.3 REFRAG 파이프라인 완성도 개선

**작업 내용**:
1. 재검색 단계 추가
   - LLM 응답 기반 재검색 로직 구현
   - 파일: `app/rag/pipeline.py` 확장

2. Context Refinement 개선
   - 여러 번의 샘플링/조합 로직 추가
   - 중요도 기반 정렬/압축 전략 개선

3. Query Rewriting 개선
   - LLM 기반 의미 확장
   - Embedding 기반 유사 쿼리 생성

**예상 시간**: 3-5일  
**우선순위**: P2 (Medium)  
**검증 방법**:
- 답변 품질 비교 (Before/After)
- REFRAG 논문과의 일치도 확인

---

## ⚡ Phase 4: Low Priority 최적화 (5-6주차)

### 4.1 성능 최적화

**작업 내용**:
1. 불필요한 재임베딩 제거
   - 파일: `app/rag/adapter.py:72-73`
   - 기존 FAISS 인덱스에서 임베딩 추출 방법 검토
   - 임베딩 캐싱 전략 수립

2. 인덱스 업데이트 최적화
   - 파일: `app/rag_server.py:2267`
   - 증분 인덱스 업데이트 구현
   - 배치 업데이트 고려

3. 캐싱 전략 개선
   - `@lru_cache` 사용 현황 검토
   - 캐시 무효화 전략 수립
   - Redis 캐싱 고려 (선택적)

4. 검색 범위 최적화
   - `SEARCH_K_MULTIPLIER` 동적 조정
   - Query complexity 기반 최적화

**예상 시간**: 2-3일  
**우선순위**: P3 (Low)  
**검증 방법**:
- 성능 벤치마크 (Before/After)
- 응답 시간 측정
- 리소스 사용량 모니터링

---

## 📊 작업 일정 요약

| Phase | 작업 | 우선순위 | 예상 시간 | 시작 주차 |
|-------|------|---------|----------|----------|
| 1 | 테이블 필터링 버그 수정 | P0 | 4-6시간 | 1주차 |
| 2 | 동시성 문제 해결 | P1 | 6-8시간 | 2주차 |
| 2 | 서버 파일 중복 해결 | P1 | 2-3일 | 2-3주차 |
| 3 | 에러 처리 및 로깅 | P2 | 1-2일 | 4주차 |
| 3 | 보안 이슈 해결 | P2 | 1일 | 4주차 |
| 3 | REFRAG 파이프라인 개선 | P2 | 3-5일 | 4주차 |
| 4 | 성능 최적화 | P3 | 2-3일 | 5-6주차 |

**총 예상 시간**: 2-3주 (Phase 1-2), 4-6주 (전체)

---

## ✅ 체크리스트

### Phase 1 완료 기준
- [x] GPS 질문에 BMS 변수 포함되지 않음 ✅
- [x] BMS 질문에 GPS 변수 포함되지 않음 ✅
- [x] 테이블 필터링 로직 테스트 통과 ✅ (4/4 테스트 통과)
- [x] 프롬프트 예시 업데이트 완료 ✅
- [x] GPS 테이블 질문에 대한 명확한 답변 규칙 추가 ✅

**Phase 1 완료일**: 2024년 12월
**완료 내용**:
- `postprocess_answer` 함수에 테이블별 변수 필터링 로직 추가
- `find_not_used_passages` 함수에 GPS 테이블 지원 추가
- 테이블 필터링 로직 개선 (is_exact=True여도 테이블 불일치 시 제외)
- 프롬프트에 GPS/BMS 테이블별 규칙 및 예시 추가
- GPS 테이블 질문에 대한 명확한 답변 규칙 추가

### Phase 2 완료 기준
- [ ] 동시 요청 테스트 통과 (100+ requests)
- [ ] 인덱스 일관성 검증 완료
- [ ] 서버 파일 통합/분리 완료
- [ ] 공통 로직 추출 완료
- [ ] 기존 기능 동작 확인 완료

### Phase 3 완료 기준
- [ ] 구조화된 로깅 설정 완료
- [ ] 예외 처리 개선 완료
- [ ] 보안 스캔 통과
- [ ] REFRAG 파이프라인 개선 완료

### Phase 4 완료 기준
- [ ] 성능 벤치마크 개선 확인
- [ ] 캐싱 전략 적용 완료
- [ ] 리소스 사용량 최적화 확인

---

## 🚨 리스크 및 대응 방안

### 리스크 1: 기존 기능 동작 중단
- **대응**: 각 Phase마다 철저한 테스트
- **대응**: 단계적 배포 (Feature Flag 사용)

### 리스크 2: 성능 저하
- **대응**: 각 변경사항마다 성능 테스트
- **대응**: 롤백 계획 수립

### 리스크 3: 일정 지연
- **대응**: 우선순위 재조정
- **대응**: Phase별 독립적 완료 가능하도록 설계

---

## 📝 참고 사항

### 개발 환경
- Python 3.x
- FastAPI
- FAISS
- Sentence-Transformers

### 테스트 전략
- 단위 테스트: 각 함수별 테스트 작성
- 통합 테스트: API 엔드포인트 테스트
- 성능 테스트: 부하 테스트 및 벤치마크

### 문서화
- 각 Phase 완료 시 문서 업데이트
- API 변경사항 문서화
- 마이그레이션 가이드 작성 (필요시)

---

## 🎯 최종 목표

1. ✅ Critical 버그 제로
2. ✅ 코드 품질 향상 (중복 제거, 구조 개선)
3. ✅ 안정성 강화 (동시성, 에러 처리)
4. ✅ 보안 강화
5. ✅ 성능 최적화 (선택적)

---

**다음 단계**: Phase 1 (테이블 필터링 버그 수정)부터 시작

